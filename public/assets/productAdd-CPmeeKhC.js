import{c as C}from"./constantData-DLrCubd0.js";import{i as B,r as z,d as u,c as V,e as c,o as _,b as t,w as l,p as x,F as A,l as P,u as U,f as s,t as v,a as r,m as H,j as L,M as J,g as G}from"./index-BIwpTUVt.js";import{j as K,n as Q}from"./kdDevice-BExDw8cT.js";const W={key:0},X={key:0},Y={class:"flex-c"},Z={class:"ml20",style:{color:"#00CC66"}},h={key:0},ee={key:1},le={key:2},te={key:3},oe={key:1},ae={class:"flex-c"},re={class:"ml20 f12",style:{color:"#00CC66"}},de={__name:"CqkdProductDataAdd",emits:["success"],setup(j,{expose:D,emit:N}){const R=N,n=B(),o=z({show:!1,type:1,form:{id:0,sort:99,name:"",unit:"",type:1,register_mark:"0",register_address:"",data_format:1,collect_frequency:3,fraction:0,storage_mode:2,read_write_mode:1,collect_formula:"",contro_formula:""}});function O(d,e){o.show=!0,o.title=d?"编辑变量":"新增变量",o.type=e||1,d?(o.form={...d},o.register_address=d.register_address,o.form.register_address=parseInt(d.register_address)):(o.form={id:0,name:"",sort:99,unit:"",type:1,register_mark:"0",register_address:"",data_format:1,collect_frequency:3,fraction:0,storage_mode:2,read_write_mode:1,collect_formula:"",contro_formula:""},e===2&&!d&&(o.form.register_mark="do",o.form.data_format=33)),b()}async function S(){if(await n.value.validate())return!1;let e=JSON.parse(JSON.stringify(o.form));return e.id||delete e.id,e.register_address=o.register_address,parseInt(o.register_value)>65536?(Message.warning("寄存器地址错误"),!1):(R("success",e),!0)}function b(){let{register_mark:d,register_address:e}=o.form;if(o.type===1){let m=4-e.length,p="";if(m>0)for(var k=0;k<m;k++)p+="0";o.register_value=o.form.register_mark+p+e,o.register_address=p+e}else o.register_value=e}return D({show:O}),(d,e)=>{const k=u("a-input-number"),m=u("a-form-item"),p=u("a-input"),y=u("a-radio"),q=u("a-radio-group"),f=u("a-option"),g=u("a-select"),$=u("a-tooltip"),F=u("icon-down"),M=u("icon-up"),i=u("icon-question-circle-fill"),I=u("a-popover"),T=u("a-form"),E=u("a-modal");return o.show?(_(),V("div",W,[t(E,{title:"新增/编辑变量信息",visible:o.show,"onUpdate:visible":e[17]||(e[17]=a=>o.show=a),width:"700px","on-before-ok":S},{default:l(()=>[t(T,{ref_key:"formRef",ref:n,model:o.form,"label-col-props":{flex:"100px"},"wrapper-col-props":{flex:1}},{default:l(()=>[t(m,{label:"变量排序"},{default:l(()=>[t(k,{placeholder:"请输入变量排序",modelValue:o.form.sort,"onUpdate:modelValue":e[0]||(e[0]=a=>o.form.sort=a)},null,8,["modelValue"])]),_:1}),t(m,{label:"变量名称",field:"name",rules:[{required:!0,message:"变量名称必填"}]},{default:l(()=>[t(p,{placeholder:"请输入变量名称",modelValue:o.form.name,"onUpdate:modelValue":e[1]||(e[1]=a=>o.form.name=a)},null,8,["modelValue"])]),_:1}),t(m,{label:"变量单位"},{default:l(()=>[t(p,{placeholder:"请输入变量单位",modelValue:o.form.unit,"onUpdate:modelValue":e[2]||(e[2]=a=>o.form.unit=a)},null,8,["modelValue"])]),_:1}),t(m,{label:"变量类型",field:"type",rules:[{required:!0,message:"变量类型必选"}]},{default:l(()=>[t(q,{modelValue:o.form.type,"onUpdate:modelValue":e[3]||(e[3]=a=>o.form.type=a)},{default:l(()=>[(_(!0),V(A,null,P(U(C).dataType,(a,w)=>(_(),x(y,{value:parseInt(w)},{default:l(()=>[s(v(a),1)]),_:2},1032,["value"]))),256))]),_:1},8,["modelValue"])]),_:1}),o.type===2?(_(),V("div",X,[t(m,{label:"寄存器"},{default:l(()=>[r("div",null,[r("div",Y,[t(g,{placeholder:"请选择寄存器",class:"w160",modelValue:o.form.register_mark,"onUpdate:modelValue":e[4]||(e[4]=a=>o.form.register_mark=a),onChange:b},{default:l(()=>[t(f,{value:"do"},{default:l(()=>e[18]||(e[18]=[s("DO(Coils Status)")])),_:1,__:[18]}),t(f,{value:"di"},{default:l(()=>e[19]||(e[19]=[s("DI(Discrete Inputs)")])),_:1,__:[19]}),t(f,{value:"ai"},{default:l(()=>e[20]||(e[20]=[s("AI(Analog input)")])),_:1,__:[20]}),t(f,{value:"ao"},{default:l(()=>e[21]||(e[21]=[s("AO(Analog output)")])),_:1,__:[21]})]),_:1},8,["modelValue"]),r("div",null,[t(p,{placeholder:"寄存器地址",modelValue:o.form.register_address,"onUpdate:modelValue":e[5]||(e[5]=a=>o.form.register_address=a),class:"w160 ml20",onChange:b},null,8,["modelValue"]),r("span",Z,[o.form.register_mark===0?(_(),V("span",h,"DO")):c("",!0),o.form.register_mark===1?(_(),V("span",ee,"DI")):c("",!0),o.form.register_mark===3?(_(),V("span",le,"AI")):c("",!0),o.form.register_mark===4?(_(),V("span",te,"AO")):c("",!0),s(" 00"+v(o.register_value)+"(位) ",1)])])]),e[22]||(e[22]=r("div",{class:"tips mt5",style:{"padding-left":"180px"}}," 寄存器地址范围1-50 ",-1))])]),_:1}),t(m,{label:"数据格式",field:"data_format",rules:[{required:!0,message:"数据格式必填"}]},{default:l(()=>[t(g,{placeholder:"请选择数据格式",modelValue:o.form.data_format,"onUpdate:modelValue":e[6]||(e[6]=a=>o.form.data_format=a)},{default:l(()=>[t(f,{value:33},{default:l(()=>e[23]||(e[23]=[s("位")])),_:1,__:[23]})]),_:1},8,["modelValue"])]),_:1})])):(_(),V("div",oe,[t(m,{label:"寄存器"},{default:l(()=>[r("div",null,[r("div",ae,[t(g,{placeholder:"请选择寄存器",class:"w160",modelValue:o.form.register_mark,"onUpdate:modelValue":e[7]||(e[7]=a=>o.form.register_mark=a),onChange:b},{default:l(()=>[t(f,{value:"0"},{default:l(()=>e[24]||(e[24]=[s("0(Coils Status)")])),_:1,__:[24]}),t(f,{value:"1"},{default:l(()=>e[25]||(e[25]=[s("1(Discrete Inputs)")])),_:1,__:[25]}),t(f,{value:"3"},{default:l(()=>e[26]||(e[26]=[s("3(Input Registers)")])),_:1,__:[26]}),t(f,{value:"4"},{default:l(()=>e[27]||(e[27]=[s("4(Holding Registers)")])),_:1,__:[27]})]),_:1},8,["modelValue"]),r("div",null,[t(p,{placeholder:"寄存器地址",modelValue:o.form.register_address,"onUpdate:modelValue":e[8]||(e[8]=a=>o.form.register_address=a),class:"w160 ml20",onChange:b},null,8,["modelValue"]),r("span",re,v(o.register_value)+"("+v(U(C).dataFormat[o.form.data_format])+") ",1)])]),e[28]||(e[28]=r("div",{class:"tips mt5",style:{"padding-left":"180px"}}," 寄存器地址范围1-65536 ",-1))])]),_:1}),t(m,{label:"数据格式",field:"data_format",rules:[{required:!0,message:"数据格式必填"}]},{default:l(()=>[t(g,{placeholder:"请选择数据格式",modelValue:o.form.data_format,"onUpdate:modelValue":e[9]||(e[9]=a=>o.form.data_format=a)},{default:l(()=>[(_(!0),V(A,null,P(U(C).dataFormat,(a,w)=>(_(),x(f,{value:parseInt(w),key:w},{default:l(()=>[s(v(a),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})])),t(m,{label:"采集频率",field:"collect_frequency",rules:[{required:!0,message:"采集频率必填"}]},{default:l(()=>[t(g,{placeholder:"请选择采集频率",modelValue:o.form.collect_frequency,"onUpdate:modelValue":e[10]||(e[10]=a=>o.form.collect_frequency=a)},{default:l(()=>[(_(!0),V(A,null,P(U(C).collectFrequency,(a,w)=>(_(),x(f,{value:parseInt(w),key:w},{default:l(()=>[s(v(a),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o.form.dataType!=="bit"?(_(),x(m,{key:2,label:"数字格式",field:"fraction",rules:[{required:!0,message:"数字格式必填"}]},{default:l(()=>[t(g,{placeholder:"请选择数字格式",modelValue:o.form.fraction,"onUpdate:modelValue":e[11]||(e[11]=a=>o.form.fraction=a)},{default:l(()=>[t(f,{value:0},{default:l(()=>e[29]||(e[29]=[s("整数")])),_:1,__:[29]}),t(f,{value:1},{default:l(()=>e[30]||(e[30]=[s("保留1位小数")])),_:1,__:[30]}),t(f,{value:2},{default:l(()=>e[31]||(e[31]=[s("保留2位小数")])),_:1,__:[31]}),t(f,{value:3},{default:l(()=>e[32]||(e[32]=[s("保留3位小数")])),_:1,__:[32]}),t(f,{value:4},{default:l(()=>e[33]||(e[33]=[s("保留4位小数")])),_:1,__:[33]})]),_:1},8,["modelValue"])]),_:1})):c("",!0),t(m,{label:"存储方式",field:"storage_mode",rules:[{required:!0,message:"存储方式必填"}]},{default:l(()=>[t(q,{modelValue:o.form.storage_mode,"onUpdate:modelValue":e[12]||(e[12]=a=>o.form.storage_mode=a)},{default:l(()=>[t(y,{value:2},{default:l(()=>e[34]||(e[34]=[s("全部存储")])),_:1,__:[34]}),t(y,{value:1},{default:l(()=>[e[36]||(e[36]=s("变化存储 ")),t($,{content:"数据有变化的时候存储 。"},{default:l(()=>e[35]||(e[35]=[r("i",{class:"ri-question-line ri-top2"},null,-1)])),_:1,__:[35]})]),_:1,__:[36]})]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"读写方式",field:"read_write_mode"},{default:l(()=>[t(q,{modelValue:o.form.read_write_mode,"onUpdate:modelValue":e[13]||(e[13]=a=>o.form.read_write_mode=a)},{default:l(()=>[t(y,{value:1},{default:l(()=>e[37]||(e[37]=[s("只读")])),_:1,__:[37]}),t(y,{value:2,disabled:["1","3"].includes(o.form.register_mark)},{default:l(()=>e[38]||(e[38]=[s("读写")])),_:1,__:[38]},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),t(m,null,{default:l(()=>[r("span",{class:"kd-link f13",onClick:e[14]||(e[14]=a=>o.more=!o.more)},[e[39]||(e[39]=s(" 高级选项 ")),o.more?(_(),x(M,{key:1})):(_(),x(F,{key:0}))])]),_:1}),o.more?(_(),V(A,{key:3},[t(m,null,{label:l(()=>[e[41]||(e[41]=r("span",null,"采集公式",-1)),t(I,null,{content:l(()=>e[40]||(e[40]=[r("div",{class:"f12"},[r("div",null,"设备上行数据经采集公式计算后显示 。"),r("div",null,"公式中的%s为占位符，是固定字段 。"),r("div",null,"如： "),r("div",null,"加：%s+10"),r("div",null,"减：%s-10"),r("div",null,"乘：%s*10"),r("div",null,"除：%s/10"),r("div",null,"余数：%s%10")],-1)])),default:l(()=>[t(i)]),_:1})]),default:l(()=>[t(p,{placeholder:"请输入采集公式",modelValue:o.form.collect_formula,"onUpdate:modelValue":e[15]||(e[15]=a=>o.form.collect_formula=a)},null,8,["modelValue"])]),_:1}),t(m,null,{label:l(()=>[e[43]||(e[43]=r("span",null,"控制公式",-1)),t(I,null,{content:l(()=>e[42]||(e[42]=[r("div",{class:"f12"},[r("div",null,"主动向设备写数据经控制公式计算后下发 。"),r("div",null,"公式中的%s为占位符，是固定字段 。"),r("div",null,"如： "),r("div",null,"加：%s+10"),r("div",null,"减：%s-10"),r("div",null,"乘：%s*10"),r("div",null,"除：%s/10"),r("div",null,"余数：%s%10")],-1)])),default:l(()=>[t(i)]),_:1})]),default:l(()=>[t(p,{placeholder:"请输入控制公式",modelValue:o.form.contro_formula,"onUpdate:modelValue":e[16]||(e[16]=a=>o.form.contro_formula=a)},null,8,["modelValue"])]),_:1})],64)):c("",!0)]),_:1},8,["model"])]),_:1},8,["visible"])])):c("",!0)}}},se={class:"kd-content"},ne={class:"flex-cc"},fe={__name:"productAdd",setup(j){const D=B(),N=B(),R=H().query,n=z({loading:!1,form:{id:0,name:"",protocol:1,status:1,variable:[]},dataIndex:-1,saving:!1});L(async()=>{let d=null;if(R.id){n.loading=!0;let e=await K({id:R.id});n.loading=!1,d=e.data}n.form={id:d?d.id:0,name:d?d.name:"",protocol:d?d.protocol:1,status:d?d.status:1,variable:d?d.variable:[]}});const o=(d,e)=>{n.dataIndex=e,D.value.show(d,n.form.protocol)};function O(d){if(n.dataIndex>=0)return n.form.variable[n.dataIndex]=d,!1;n.form.variable.push(d)}function S(d){n.form.variable.splice(d,1)}async function b(){if(await N.value.validate())return!1;let e=JSON.parse(JSON.stringify(n.form));e.id||delete e.id,n.saving=!0;let k=await Q(e);if(n.saving=!1,k.code===200){J.success("保存成功"),setTimeout(function(){G.go(-1)},500);return}J.error(k.msg)}return(d,e)=>{const k=u("kd-back"),m=u("a-input"),p=u("a-form-item"),y=u("a-radio"),q=u("a-radio-group"),f=u("a-switch"),g=u("a-button"),$=u("a-table"),F=u("a-form"),M=u("kd-page-box");return _(),x(M,{loading:n.loading},{default:l(()=>[r("div",se,[t(k,{title:"新增/编辑产品"}),t(F,{ref_key:"formRef",ref:N,model:n.form,"label-col-props":{flex:"130px"},"wrapper-col-props":{flex:1}},{default:l(()=>[t(p,{label:"产品名称",field:"name",rules:[{required:!0,message:"产品名称必填"}]},{default:l(()=>[t(m,{placeholder:"请输入产品名称",modelValue:n.form.name,"onUpdate:modelValue":e[0]||(e[0]=i=>n.form.name=i),class:"w600"},null,8,["modelValue"])]),_:1}),t(p,{label:"产品协议",field:"protocol",required:""},{default:l(()=>[t(q,{modelValue:n.form.protocol,"onUpdate:modelValue":e[1]||(e[1]=i=>n.form.protocol=i),disabled:n.form.variable.length},{default:l(()=>[t(y,{value:1},{default:l(()=>e[4]||(e[4]=[s("Modbus RTU协议")])),_:1,__:[4]}),t(y,{value:2},{default:l(()=>e[5]||(e[5]=[s("自定义协议")])),_:1,__:[5]})]),_:1},8,["modelValue","disabled"])]),_:1}),t(p,{label:"状态"},{default:l(()=>[t(f,{modelValue:n.form.status,"onUpdate:modelValue":e[2]||(e[2]=i=>n.form.status=i),"checked-value":1,"unchecked-value":0,"checked-text":"启用","unchecked-text":"禁用"},null,8,["modelValue"])]),_:1}),t(p,{label:"变量列表"},{default:l(()=>[t($,{class:"kd-small-table",style:{width:"800px"},pagination:!1,data:n.form.variable,columns:[{title:"ID",dataIndex:"id"},{title:"变量名称",dataIndex:"name"},{title:"变量类型",slotName:"type"},{title:"数值类型",slotName:"data_format"},{title:"寄存器",slotName:"register"},{title:"读写",slotName:"read_write_mode"},{title:"存储方式",slotName:"storage_mode"},{title:"排序",dataIndex:"sort"},{title:"操作",slotName:"action"}]},{type:l(({record:i})=>[r("span",null,v(U(C).dataType[i.type]),1)]),data_format:l(({record:i})=>[r("span",null,v(U(C).dataFormat[i.data_format]),1)]),register:l(({record:i})=>[r("span",null,v(i.register_mark)+v(i.register_address),1)]),read_write_mode:l(({record:i})=>[r("span",null,v(i.read_write_mode===1?"只读":"读写"),1)]),storage_mode:l(({record:i})=>[r("span",null,v(i.storage_mode===1?"变化存储":"全部存储"),1)]),action:l(({record:i,rowIndex:I})=>[t(g,{type:"text",size:"mini",class:"ml-10",onClick:T=>o(i,I)},{default:l(()=>e[6]||(e[6]=[s("编辑")])),_:2,__:[6]},1032,["onClick"]),t(g,{type:"text",size:"mini",class:"ml-10",onClick:T=>S(I)},{default:l(()=>e[7]||(e[7]=[s("删除")])),_:2,__:[7]},1032,["onClick"])]),footer:l(()=>[r("div",ne,[t(g,{type:"text",size:"mini",onClick:e[3]||(e[3]=i=>o(null,-1))},{default:l(()=>e[8]||(e[8]=[r("i",{class:"ri-add-line"},null,-1),s("新增变量 ")])),_:1,__:[8]})])]),_:1},8,["data"])]),_:1}),t(p,null,{default:l(()=>[t(g,{type:"primary",class:"w120",loading:n.saving,onClick:b},{default:l(()=>e[9]||(e[9]=[s("保存")])),_:1,__:[9]},8,["loading"])]),_:1})]),_:1},8,["model"])]),t(de,{ref_key:"addRef",ref:D,onSuccess:O},null,512)]),_:1},8,["loading"])}}};export{fe as default};
