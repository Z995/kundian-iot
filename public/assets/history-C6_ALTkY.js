import{i as J}from"./index-Bb6yjXMn.js";import{_ as Y,r as F,d as y,c as p,o as d,e as B,l as k,E as U,a as f,F as C,k as M,n as q,t as S,b as v,x as A,G as m,j as O,M as T,w as g,f as H,v as K}from"./index-B09Km9Qy.js";import{a as R,g as z,f as j,o as W}from"./kdDevice-C_HdGTFt.js";import{K as G}from"./KdMarkerAddress-kfqaZ62o.js";import"./TianDiMap-CZQsJKr7.js";const Z={class:"history-data-box"},P={key:0,class:"history-data-box",id:"historyLine"},Q={__name:"KdHistoryDataLine",setup(N,{expose:D}){let n=null;const o=F({list:[]});function e(c){o.list=c,U(()=>{var w;var h=document.getElementById("historyLine");if(!c.length)return!1;n&&(n.dispose(),n=null),n=J(h);let t=[],l=[];for(let u=0;u<c.length;u++)for(let a=0;a<c[u].log.length;a++)t.push(c[u].log[a].create_time);const _=Array.from(new Set(t));_.sort((u,a)=>new Date(u).getTime()-new Date(a).getTime());for(let u=0;u<c.length;u++){let a=[];for(let i=0;i<_.length;i++){let s=c[u].log.find(b=>_[i]===b.create_time);s?a.push(parseFloat(s.val)):a.push("")}l.push({name:(w=c[u].variable)==null?void 0:w.name,data:a,connectNulls:!0,type:"line",smooth:!0,symbolSize:8,symbol:"circle",lineStyle:{width:3},itemStyle:{borderColor:"#fff",borderWidth:2}})}let x={color:["#3c78ff","#00CC66","#c0cff3","#00CCFF","#6666FF","#CC33CC","#FF66CC","#009966","#ff9659"],grid:{left:"2%",right:"4%",bottom:"13%",top:"15%",containLabel:!0},legend:{show:!0,itemWidth:12,itemHeight:12,top:"1%"},dataZoom:[{show:!0,type:"slider",bottom:0,y:"90%",start:_.length<100?0:60,height:30,end:100}],tooltip:{trigger:"axis"},xAxis:{type:"category",data:_,axisTick:{show:!1},axisLabel:{textStyle:{color:"#4E5969"},showMaxLabel:!0,formatter:function(u){let a=new Date(u),i=a.getHours(),s=a.getMinutes();return a.getSeconds(),(i<10?"0"+i:i)+":"+(s<10?"0"+s:s)}},axisLine:{lineStyle:{color:"#EAEBF0"}}},yAxis:{type:"value",axisLabel:{textStyle:{color:"#4E5969"}},splitLine:{lineStyle:{type:"dashed"}}},series:l};x&&n.setOption(x)})}return D({drawData:e}),(c,h)=>{const t=y("kd-empty");return d(),p("div",Z,[o.list.length?(d(),p("div",P)):B("",!0),o.list.length?B("",!0):(d(),k(t,{key:1,height:390}))])}}},X=Y(Q,[["__scopeId","data-v-5a11e266"]]),ee={class:"history-list"},te={class:"data-type flex mt20 mb10"},ae=["onClick"],ie={key:0},oe={__name:"KdHistoryDataList",setup(N,{expose:D}){const n=F({loading:!1,type:1,info:{list:[],page:1,limit:10,count:0},columns:[{title:"数值",dataIndex:"val"},{title:"更新时间",dataIndex:"create_time"}],dataList:[],logList:[],data_id:0});function o(e,c){n.dataList=e,n.logList=c,e.length&&(n.data_id=e[0].id)}return D({refreshData:o}),(e,c)=>{const h=y("a-table");return d(),p("div",ee,[f("div",te,[(d(!0),p(C,null,M(n.dataList,(t,l)=>(d(),p("div",{class:q(["type-item",{active:n.data_id===t.id}]),key:l,onClick:_=>n.data_id=t.id},S(t.name),11,ae))),128))]),(d(!0),p(C,null,M(n.logList,(t,l)=>(d(),p(C,{key:l},[t.variable.id===n.data_id?(d(),p("div",ie,[v(h,{class:"kd-small-table",pagination:{pageSize:40},"row-key":"id",bordered:!1,data:t.log,columns:n.columns},null,8,["data","columns"])])):B("",!0)],64))),128))])}}},ne=Y(oe,[["__scopeId","data-v-c16497bd"]]),le={__name:"KdSearch",emits:["search","changeDevice","changeData"],setup(N,{emit:D}){const n=D,o=A().query,e=F({info:{page:1,limit:30,list:[]},slaveList:[],dataList:[],search:{name:"",device_id:null,slave_id:null,data_id:[],time:[]},rangeShortcuts:[{label:"最近七日",value:()=>[m().subtract(7,"day"),m()]},{label:"最近一个月",value:()=>[m().subtract(1,"month"),m()]},{label:"最近三个月",value:()=>[m().subtract(3,"month"),m()]},{label:"最近一年",value:()=>[m().subtract(1,"year"),m()]}]});O(async()=>{var a;if(e.search.time=[c(m().subtract(1,"hour")),c(m())],o.device_id&&(e.search.device_id=parseInt(o.device_id)),o.slave_id){e.search.slave_id=parseInt(o.slave_id);let i=await R({subordinate_id:o.slave_id});e.dataList=((a=i.data)==null?void 0:a.list)||[]}o.id&&(e.search.data_id=[parseInt(o.id)],w()),h(1,e.info.limit)});function c(a){return m(a).format("YYYY-MM-DD HH:mm")}function h(a,i){e.info.page=a||e.info.page,e.info.limit=i||e.info.limit;let s={page:e.info.page,limit:e.info.limit},b=e.search;b&&b.name&&(s.name=b.name),z(s).then(I=>{var V,$;I.code===200&&(e.info.list=a===1?((V=I.data)==null?void 0:V.list)||[]:e.info.list.concat((($=I.data)==null?void 0:$.list)||[]),a===1&&o.device_id&&e.info.list.findIndex(L=>L.id===parseInt(o.device_id))!==-1&&j({id:o.device_id}).then(L=>{var E;e.info.list.push(L.data),e.slaveList=((E=L.data)==null?void 0:E.subordinate)||[],n("changeDevice",L.data)}))})}function t(a){e.search.key=a,h(1,30)}function l(){e.search.name="",h(1,e.info.limit)}function _(){let{device_id:a}=e.search;if(e.search.slave_id=null,e.search.data_id=[],e.slaveList=[],e.dataList=[],!a)return!1;j({id:a}).then(i=>{var s;e.slaveList=((s=i.data)==null?void 0:s.subordinate)||[],n("changeDevice",i.data)})}function x(){e.search.data_id=[],e.dataList=[];let{slave_id:a}=e.search;if(!a)return!1;R({subordinate_id:a}).then(i=>{e.dataList=i.data.list||[]})}function w(){let{data_id:a}=e.search;if(!a.length){T.warning("请选择变量");return}let i=[];for(var s=0;s<e.dataList.length;s++)a.includes(e.dataList[s].id)&&i.push(e.dataList[s]);n("changeData",i),n("search",JSON.parse(JSON.stringify(e.search)))}function u(){e.search={name:"",device_id:null,slave_id:null,data_id:[],time:[m().subtract(1,"hour"),m()]}}return(a,i)=>{const s=y("a-option"),b=y("a-select"),I=y("a-range-picker"),V=y("a-button"),$=y("a-space");return d(),k($,null,{default:g(()=>[v(b,{class:"w160",placeholder:"请选择设备",modelValue:e.search.device_id,"onUpdate:modelValue":i[0]||(i[0]=r=>e.search.device_id=r),"allow-search":!0,"allow-clear":"",onSearch:t,"filter-option":!1,onClear:l,onDropdownReachBottom:i[1]||(i[1]=r=>h(e.info.page+1,e.info.limit)),onChange:_},{default:g(()=>[(d(!0),p(C,null,M(e.info.list,r=>(d(),k(s,{value:r.id},{default:g(()=>[H(S(r.name),1)]),_:2},1032,["value"]))),256))]),_:1},8,["modelValue"]),v(b,{placeholder:"请选择从机",class:"w160","allow-clear":"",modelValue:e.search.slave_id,"onUpdate:modelValue":i[2]||(i[2]=r=>e.search.slave_id=r),onChange:x,onClear:x},{default:g(()=>[(d(!0),p(C,null,M(e.slaveList,(r,L)=>(d(),k(s,{key:L,value:r.id},{default:g(()=>[H(S(r.subordinate.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),v(b,{placeholder:"请选择变量",class:"w340",multiple:"","max-tag-count":3,"allow-clear":"",modelValue:e.search.data_id,"onUpdate:modelValue":i[3]||(i[3]=r=>e.search.data_id=r)},{default:g(()=>[(d(!0),p(C,null,M(e.dataList,(r,L)=>(d(),k(s,{key:L,value:r.id},{default:g(()=>[H(S(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),v(I,{class:"w340","show-time":"",format:"YYYY-MM-DD HH:mm","shortcuts-position":"left",shortcuts:e.rangeShortcuts,modelValue:e.search.time,"onUpdate:modelValue":i[4]||(i[4]=r=>e.search.time=r)},null,8,["shortcuts","modelValue"]),v(V,{type:"primary",onClick:w},{default:g(()=>i[5]||(i[5]=[H("查询")])),_:1,__:[5]}),v(V,{onClick:u},{default:g(()=>i[6]||(i[6]=[H("重置")])),_:1,__:[6]})]),_:1})}}},se={class:"kd-content"},de={class:"history-box flex mt20"},re={class:"info-box"},ce={class:"info-data f12"},ue={class:"info-item flex mt10"},fe={class:"ii-value"},_e={class:"info-item flex"},me={class:"ii-value"},pe={class:"info-data mt20"},ve={key:0,class:"map-box"},ge={__name:"history",setup(N){A().query;const D=K(),n=K(),o=F({loading:!1,search:null,deviceInfo:null,recordList:[],selectDataList:[]});O(()=>{});function e(t){if(o.search=t,!(t!=null&&t.data_id)||!(t!=null&&t.data_id.length))return T.warning("请选择变量"),!1;let l={ids:t==null?void 0:t.data_id.join(",")};t!=null&&t.time&&(t!=null&&t.time.length)&&(l.start_time=t==null?void 0:t.time[0],l.end_time=t==null?void 0:t.time[1]),o.loading=!0,W(l).then(_=>{o.loading=!1,o.recordList=_.data,D.value.drawData(_.data),n.value.refreshData(o.selectDataList,_.data)}).catch(()=>{o.loading=!1})}function c(t){o.deviceInfo=t}function h(t){o.selectDataList=JSON.parse(JSON.stringify(t))}return(t,l)=>{const _=y("a-spin"),x=y("kd-empty"),w=y("a-card"),u=y("kd-page-box");return d(),k(u,null,{default:g(()=>[f("div",se,[v(w,{title:"设备历史记录",bordered:!1},{default:g(()=>{var a;return[v(le,{onSearch:e,onChangeDevice:c,onChangeData:h}),f("div",de,[v(_,{loading:o.loading,tip:"数据加载中...",class:"line-box"},{default:g(()=>[f("div",null,[l[0]||(l[0]=f("div",{class:"f14 fb hb-title"},"曲线趋势图",-1)),v(X,{ref_key:"dataLineRef",ref:D},null,512)])]),_:1},8,["loading"]),f("div",re,[f("div",ce,[l[3]||(l[3]=f("div",{class:"f14 fb hb-title"},"设备信息",-1)),o.deviceInfo?(d(),p(C,{key:0},[f("div",ue,[l[1]||(l[1]=f("div",{class:"ii-title"},"设备名称：",-1)),f("div",fe,S(o.deviceInfo.name),1)]),f("div",_e,[l[2]||(l[2]=f("div",{class:"ii-title"},"设备模板：",-1)),f("div",me,S(((a=o.deviceInfo.template)==null?void 0:a.name)||"-"),1)])],64)):(d(),k(x,{key:1}))]),f("div",pe,[l[4]||(l[4]=f("div",{class:"f14 fb hb-title"},"设备地图",-1)),o.deviceInfo?(d(),p("div",ve,[v(G,{id:"markerMapBox",latitude:o.deviceInfo.latitude,longitude:o.deviceInfo.longitude},null,8,["latitude","longitude"])])):(d(),k(x,{key:1}))])])]),v(ne,{ref_key:"dataListRef",ref:n},null,512)]}),_:1})])]),_:1})}}},xe=Y(ge,[["__scopeId","data-v-ea8f5141"]]);export{xe as default};
