import{c as Z,e as ee,f as te,s as le}from"./kdDevice-tpIu9Cvi.js";import{c as F}from"./constantData-DLrCubd0.js";import{_ as q,r as K,d as m,c as b,e as N,o as _,b as o,w as i,a as n,F as j,l as E,p as O,n as ae,t as g,f as w,u as A,M as B,i as R,m as oe,j as ne,g as ie}from"./index-3_WCOcxA.js";import{K as se}from"./index-_FlZdnJK.js";import{C as de}from"./CqkdSelectLabel-CNjBt4xo.js";import{d as ue}from"./kdLive-G86hqvIb.js";import{g as me}from"./kdGateway-BQGSNawP.js";import"./TianDiMap-3SN5_Mvs.js";const re={key:0},ce={class:"mould-box flex"},_e={class:"f12"},fe={class:"mould-data"},pe={class:"flex-c mb10 f12"},ve={class:"count"},be={class:"count"},ge={class:"count"},ke={__name:"KdSelectDeviceMould",emits:["success"],setup(T,{expose:V,emit:C}){const D=C,t=K({loading:!1,show:!1,mouldList:[],page:0,columns:[{title:"从机名称",dataIndex:"slave_name"},{title:"变量名称",dataIndex:"name"},{title:"数值类型",slotName:"data_format"}],template_id:null,info:{name:"",variable_count:0,collect:1,slave:0,subordinate:[],data:[]}});function $(p){t.show=!0,p&&S(p)}function l(p){t.page=p;let d={page:t.page,limit:30};Z(d).then(s=>{var f,r;s.code===200&&((r=(f=s.data)==null?void 0:f.list)!=null&&r.length)&&(t.mouldList=p===1?s.data.list:t.mouldList.concat(s.data.list))}).catch(()=>{})}function S(p){t.template_id=p.id,t.loading=!0;let d={name:p.name,variable_count:p.variable_count,collect:p.collect,slave:0,subordinate:[],data:[]};ee({id:p.id}).then(s=>{var f;if(t.loading=!1,(f=s.data)!=null&&f.id){d.slave=s.data.subordinate.length,d.subordinate=s.data.subordinate;let r=[];d.subordinate.forEach(h=>{h.variable.forEach(x=>{r.push({...x,slave_name:h.name})})}),d.data=r}t.info=d}).catch(()=>{t.loading=!1})}async function M(){let{template_id:p,info:d}=t;if(!p)return B.warning("请选择设备模板"),!1;let s=[];d.subordinate.forEach(f=>{s.push({subordinate_id:f.id,name:f.name,protocol:f.protocol})}),D("success",{template_id:p,template_name:d.name,data:s})}return V({open:$}),(p,d)=>{const s=m("a-radio"),f=m("a-list-item"),r=m("a-list"),h=m("a-table"),x=m("a-modal");return t.show?(_(),b("div",re,[o(x,{title:"选择模板",visible:t.show,"onUpdate:visible":d[2]||(d[2]=y=>t.show=y),width:"1000px","on-before-ok":M},{default:i(()=>[n("div",ce,[o(r,{bordered:!1,class:"mould-list","max-height":400,onReachBottom:d[1]||(d[1]=y=>l(t.page+1))},{default:i(()=>[(_(!0),b(j,null,E(t.mouldList,(y,U)=>(_(),O(f,{key:U,class:ae({active:t.template_id===y.id}),onClick:e=>S(y)},{default:i(()=>[o(s,{value:y.id,modelValue:t.template_id,"onUpdate:modelValue":d[0]||(d[0]=e=>t.template_id=e)},{default:i(()=>[n("span",_e,g(y.name),1)]),_:2},1032,["value","modelValue"])]),_:2},1032,["class","onClick"]))),128))]),_:1}),n("div",fe,[n("div",pe,[n("span",ve,"从机数量："+g(t.info.slave),1),n("span",be,"变量数量："+g(t.info.variable_count),1),n("span",ge,"采集方式："+g(t.info.collect===1?"云端轮询":"边缘计算"),1)]),o(h,{class:"kd-small-table","row-key":"id",bordered:!1,data:t.info.data,columns:t.columns,loading:t.loading},{data_format:i(({record:y})=>[w(g(A(F).dataFormat[y.data_format]),1)]),_:1},8,["data","columns","loading"])])])]),_:1},8,["visible"])])):N("",!0)}}},ye=q(ke,[["__scopeId","data-v-0e0dfecf"]]),we={key:0},he={class:"live-box"},xe={key:0},Le={key:1},Ie={key:2},Ve={__name:"CqkdSelectLive",emits:["select"],setup(T,{expose:V,emit:C}){const D=C,t=K({show:!1,loading:!1,search:{name:""},info:{page:1,limit:10,count:0,list:[]},selectId:[],selectLive:[]});function $(){t.show=!0,t.selectId=[],t.selectLive=[],l(1,10)}function l(d,s){t.info.page=d||t.info.page,t.info.limit=s||t.info.limit;let f={page:t.info.page,limit:t.info.limit};t.search.name&&(f.name=t.search.name),t.loading=!0,ue(f).then(r=>{var h,x;t.loading=!1,r.code===200&&(t.info.list=((h=r.data)==null?void 0:h.list)||[],t.info.count=((x=r.data)==null?void 0:x.count)||0)}).catch(()=>{t.loading=!1})}function S(){t.search.name="",l(1,t.info.limit)}function M(d){if(t.selectId.includes(d.id)){let s=t.selectId.findIndex(r=>r===d.id);t.selectId.splice(s,1);let f=t.selectLive.findIndex(r=>r.id===d.id);t.selectLive.splice(f,1)}else t.selectId.push(d.id),t.selectLive.push(JSON.parse(JSON.stringify(d)))}function p(){return console.log(t.selectId),console.log(t.selectLive),t.selectId.length?(D("select",{ids:t.selectId,list:JSON.parse(JSON.stringify(t.selectLive))}),!0):(B.warning("请选择监控"),!1)}return V({show:$}),(d,s)=>{const f=m("a-input"),r=m("a-button"),h=m("a-space"),x=m("a-table"),y=m("kd-pager"),U=m("a-modal");return t.show?(_(),b("div",we,[o(U,{title:"选择监控",visible:t.show,"onUpdate:visible":s[2]||(s[2]=e=>t.show=e),width:"800px","on-before-ok":p},{default:i(()=>[o(h,null,{default:i(()=>[o(f,{placeholder:"请输入监控名称",modelValue:t.search.name,"onUpdate:modelValue":s[0]||(s[0]=e=>t.search.name=e),class:"w300"},null,8,["modelValue"]),o(r,{type:"primary",class:"ml10",onClick:s[1]||(s[1]=e=>l(1,t.info.limit))},{default:i(()=>s[3]||(s[3]=[w("查询")])),_:1,__:[3]}),o(r,{class:"ml10",onClick:S},{default:i(()=>s[4]||(s[4]=[w("重置")])),_:1,__:[4]})]),_:1}),n("div",he,[o(x,{class:"mt10 kd-small-table","row-key":"id",pagination:!1,bordered:!1,data:t.info.list,loading:t.loading,columns:[{title:"ID",dataIndex:"id",width:80},{title:"监控名称",slotName:"name"},{title:"监控协议",slotName:"related_type"},{title:"操作",slotName:"action",width:100,fixed:"right"}]},{related_type:i(({record:e})=>[n("span",null,g(A(F).livePlatform[e.related_type]),1)]),name:i(({record:e})=>[e.related_type==="local"?(_(),b("div",xe,[n("div",null,g(e.name),1)])):e.related_type==="kun_dian"?(_(),b("div",Le,[n("div",null,g(e.desc||e.name),1)])):(_(),b("div",Ie,[n("div",null,g(e.name),1)]))]),action:i(({record:e})=>[o(r,{type:t.selectId.includes(e.id)?"primary":"dashed",size:"mini",onClick:a=>M(e)},{default:i(()=>[w(g(t.selectId.includes(e.id)?"已选择":"选择"),1)]),_:2},1032,["type","onClick"])]),_:1},8,["data","loading"])]),o(y,{"page-data":t.info,event:l},null,8,["page-data"])]),_:1},8,["visible"])])):N("",!0)}}},Ce=q(Ve,[["__scopeId","data-v-27a86301"]]),De={class:"kd-content"},$e={class:"device-add-box"},Se={class:"label-box flex"},Ne=["onClick"],Me={class:"w600"},Ue={key:0,class:"w400"},Re={class:"device-add-box mt20"},je={key:0},Ee={key:0,class:"cong-ji-box mt10"},Oe={class:"cj-name fb f12"},Be={class:"cj-content flex-c ml20"},Je={class:"device-add-box mt20 mb20"},qe={class:"device-add-box mt20 mb20"},Ke={key:0},Te={key:1},ze={key:2},Fe={__name:"deviceAdd",setup(T){const V=R(),C=R(),D=R(),t=R(),$=oe().query,l=K({loading:!1,saving:!1,form:{id:0,gateway_id:null,template_id:null,name:"",describe:"",label_ids:[],location:2,longitude:"",latitude:"",monitor_ids:"",subordinate:[]},location:[],label:[],gatewayList:[],mouldInfo:null,template:null,live:[]});ne(async()=>{var a,c;l.loading=!0,s();let e=null;if($.id){let v=await te({id:$.id});(a=v.data)!=null&&a.id&&(e=v.data)}if(l.form={id:e?e.id:0,gateway_id:e?e.gateway_id:null,template_id:e?e.template_id:null,name:e?e.name:"",describe:e?e.describe:"",monitor_ids:e?e.monitor_ids:"",label_ids:[],location:e?e.location:2,longitude:e?e.longitude:"",latitude:e?e.latitude:"",subordinate:[]},e){if(l.mouldInfo={name:((c=e.template)==null?void 0:c.name)||"",subordinate:[]},e.label.length&&(l.label=e.label),e.location===1&&(l.location=[e.longitude,e.latitude]),e.label_ids&&typeof e.label_ids=="string"&&(l.form.label_ids=e.label_ids.split(",")),e!=null&&e.subordinate.length){let v=[];e.subordinate.forEach(k=>{var I;v.push({template_subordinate_id:k.template_subordinate_id,name:(I=k.subordinate)==null?void 0:I.name,serial_port:k.serial_port,subordinate_address:k.subordinate_address,protocol:k.protocol})}),l.mouldInfo.subordinate=v}l.template=e.template||null,e.monitor&&(l.live=e.monitor)}l.loading=!1});const S=()=>V.value.open(l.template),M=()=>C.value.show(l.form.label_ids),p=()=>t.value.show();function d(e){e&&(l.form.label_ids=e.id,l.label=e.list)}function s(e){let a={page:1,limit:20};e&&(a.name=e),me(a).then(c=>{var v;l.gatewayList=((v=c.data)==null?void 0:v.list)||[]})}function f(e){e&&(l.form.longitude=e.location[0],l.form.latitude=e.location[1])}function r(e){l.form.template_id=e.template_id;let a=[];e.data.forEach(c=>{a.push({template_subordinate_id:c.subordinate_id,protocol:c.protocol,name:c.name,serial_port:"",subordinate_address:""})}),l.mouldInfo={name:e.template_name,subordinate:a}}function h(){l.form.template_id=null,l.form.subordinate=[],l.mouldInfo=null}function x(e){console.log(e),l.live=l.live.concat(e.list)}function y(e){l.live.splice(e,1)}async function U(){if(await D.value.validate())return!1;let a=JSON.parse(JSON.stringify(l.form));if(a.id||delete a.id,l.mouldInfo){let c=[];l.mouldInfo.subordinate.forEach(v=>{c.push({serial_port:v.serial_port,subordinate_address:v.subordinate_address,template_subordinate_id:v.template_subordinate_id})}),a.subordinate=c}if(a.label_ids&&a.label_ids.length?a.label_ids=a.label_ids.join(","):a.label_ids="",l.live&&l.live.length){let c=[];l.live.forEach(v=>{c.push(v.id)}),a.monitor_ids=c.join(",")}l.saving=!0;try{let c=await le(a);if(l.saving=!1,c.code===200){B.success("保存成功"),setTimeout(function(){ie.go(-1)},500);return}B.error(c.msg)}catch(c){console.log("js错误:",c)}}return(e,a)=>{const c=m("kd-back"),v=m("a-input"),k=m("a-form-item"),I=m("a-button"),z=m("a-radio"),G=m("a-radio-group"),P=m("a-popconfirm"),H=m("a-option"),Q=m("a-select"),W=m("a-table"),X=m("a-form"),Y=m("kd-page-box");return _(),O(Y,{loading:l.loading},{default:i(()=>[n("div",De,[o(c,{title:"新增设备"}),o(X,{ref_key:"formRef",ref:D,model:l.form,"label-col-props":{flex:"110px"},"wrapper-col-props":{flex:1}},{default:i(()=>[n("div",$e,[a[9]||(a[9]=n("div",{class:"f13 mb20"},"基本信息",-1)),o(k,{label:"设备名称",field:"name",rules:[{required:!0,message:"设备名称必填"}]},{default:i(()=>[o(v,{modelValue:l.form.name,"onUpdate:modelValue":a[0]||(a[0]=u=>l.form.name=u),placeholder:"请输入设备名称",class:"w600"},null,8,["modelValue"])]),_:1}),o(k,{label:"设备描述"},{default:i(()=>[o(v,{modelValue:l.form.describe,"onUpdate:modelValue":a[1]||(a[1]=u=>l.form.describe=u),placeholder:"请输入设备描述",class:"w600"},null,8,["modelValue"])]),_:1}),o(k,{label:"设备标签"},{default:i(()=>[n("div",Se,[(_(!0),b(j,null,E(l.label,(u,L)=>(_(),b("div",{class:"label-item",key:L},[w(g(u.name)+" ",1),n("div",{class:"del-icon",onClick:J=>e.delLabel(L)},a[5]||(a[5]=[n("i",{class:"ri-close-line"},null,-1)]),8,Ne)]))),128)),o(I,{type:"outline",onClick:M},{default:i(()=>a[6]||(a[6]=[w("添加标签")])),_:1,__:[6]})])]),_:1}),o(k,{label:"设备位置"},{default:i(()=>[o(G,{modelValue:l.form.location,"onUpdate:modelValue":a[2]||(a[2]=u=>l.form.location=u)},{default:i(()=>[o(z,{value:2},{default:i(()=>a[7]||(a[7]=[w("网关定位")])),_:1,__:[7]}),o(z,{value:1},{default:i(()=>a[8]||(a[8]=[w("手动定位")])),_:1,__:[8]})]),_:1},8,["modelValue"])]),_:1}),l.form.location===1?(_(),O(k,{key:0,label:"设备地图"},{default:i(()=>[n("div",Me,[l.loading?N("",!0):(_(),b("div",Ue,[o(se,{lngLat:l.location,onSuccess:f},null,8,["lngLat"])]))])]),_:1})):N("",!0)]),n("div",Re,[a[13]||(a[13]=n("div",{class:"f13 mb20"},"数据设置",-1)),o(k,{label:"关联设备模板"},{default:i(()=>[n("div",null,[n("div",null,[l.form.template_id&&l.mouldInfo?(_(),b("span",je,[n("span",null,g(l.mouldInfo.name),1),o(P,{content:"确认请删除所选模板数据吗？",onOk:h},{default:i(()=>a[10]||(a[10]=[n("span",{class:"kd-link ml20 mr20"},"删除",-1)])),_:1,__:[10]})])):N("",!0),o(I,{type:"outline",onClick:S},{default:i(()=>a[11]||(a[11]=[w("选择模板")])),_:1,__:[11]})]),l.mouldInfo?(_(),b("div",Ee,[(_(!0),b(j,null,E(l.mouldInfo.subordinate,(u,L)=>(_(),b("div",{class:"cj-item flex-c mt10",key:L},[n("div",Oe,g(u.name),1),n("div",Be,[a[12]||(a[12]=n("span",null,"从机地址：",-1)),o(v,{modelValue:u.subordinate_address,"onUpdate:modelValue":J=>u.subordinate_address=J,placeholder:"从机地址",class:"w200"},null,8,["modelValue","onUpdate:modelValue"])])]))),128))])):N("",!0)])]),_:1})]),n("div",Je,[a[14]||(a[14]=n("div",{class:"f13 mb20"},"联网设置",-1)),o(k,{label:"管理网关",modelValue:l.form.gateway_id,"onUpdate:modelValue":a[4]||(a[4]=u=>l.form.gateway_id=u)},{default:i(()=>[o(Q,{class:"w600",placeholder:"请选择网关","allow-clear":"",modelValue:l.form.gateway_id,"onUpdate:modelValue":a[3]||(a[3]=u=>l.form.gateway_id=u),onSearch:s,"filter-option":!0,"allow-search":!0},{default:i(()=>[(_(!0),b(j,null,E(l.gatewayList,(u,L)=>(_(),O(H,{value:u.id,key:L},{default:i(()=>[w(g(u.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),n("div",qe,[a[17]||(a[17]=n("div",{class:"f13 mb20"},"绑定监控",-1)),o(k,{label:"选择监控"},{default:i(()=>[n("div",null,[o(W,{class:"w600 kd-small-table",pagination:!1,data:l.live,columns:[{title:"ID",dataIndex:"id"},{title:"监控名称",slotName:"name"},{title:"操作",slotName:"action"}]},{name:i(({record:u})=>[u.related_type==="local"?(_(),b("div",Ke,[n("div",null,g(u.name),1)])):u.related_type==="kun_dian"?(_(),b("div",Te,[n("div",null,g(u.desc||u.name),1)])):(_(),b("div",ze,[n("div",null,g(u.name),1)]))]),action:i(({record:u,rowIndex:L})=>[o(I,{type:"text",size:"mini",class:"ml-12",onClick:J=>y(L)},{default:i(()=>a[15]||(a[15]=[w("删除")])),_:2,__:[15]},1032,["onClick"])]),_:1},8,["data"]),n("div",{class:"w600 add-live",onClick:p},a[16]||(a[16]=[n("i",{class:"ri-add-line"},null,-1),w("添加一个 ")]))])]),_:1})]),o(k,null,{default:i(()=>[o(I,{type:"primary",class:"w120 ml20",loading:l.saving,onClick:U},{default:i(()=>a[18]||(a[18]=[w(" 保存 ")])),_:1,__:[18]},8,["loading"])]),_:1})]),_:1},8,["model"])]),o(ye,{ref_key:"mouldRef",ref:V,onSuccess:r},null,512),o(de,{ref_key:"labelRef",ref:C,onSuccess:d},null,512),o(Ce,{ref_key:"liveRef",ref:t,onSelect:x},null,512)]),_:1},8,["loading"])}}},Ze=q(Fe,[["__scopeId","data-v-6089e23b"]]);export{Ze as default};
