import{c as z,e as H,f as P,s as Q}from"./kdDevice-C_HdGTFt.js";import{c as W}from"./constantData-BoRWJogH.js";import{_ as B,r as q,d as _,c as v,e as x,o as p,b as s,w as d,a as n,F as S,k as $,l as M,n as X,t as w,f as k,q as Y,M as E,v as R,x as Z,j as ee,g as ae}from"./index-B09Km9Qy.js";import{K as le}from"./index-Cux7RQI6.js";import{C as oe}from"./CqkdSelectLabel-CzbhJYh6.js";import{g as te}from"./kdGateway-7ZUwpcTm.js";import"./TianDiMap-CZQsJKr7.js";const se={key:0},ne={class:"mould-box flex"},de={class:"f12"},ie={class:"mould-data"},re={class:"flex-c mb10 f12"},ue={class:"count"},me={class:"count"},ce={class:"count"},_e={__name:"KdSelectDeviceMould",emits:["success"],setup(K,{expose:h,emit:L}){const D=L,o=q({loading:!1,show:!1,mouldList:[],page:0,columns:[{title:"从机名称",dataIndex:"slave_name"},{title:"变量名称",dataIndex:"name"},{title:"数值类型",slotName:"data_format"}],template_id:null,info:{name:"",variable_count:0,collect:1,slave:0,subordinate:[],data:[]}});function l(m){o.show=!0,m&&I(m)}function U(m){o.page=m;let r={page:o.page,limit:30};z(r).then(f=>{var b,g;f.code===200&&((g=(b=f.data)==null?void 0:b.list)!=null&&g.length)&&(o.mouldList=m===1?f.data.list:o.mouldList.concat(f.data.list))}).catch(()=>{})}function I(m){o.template_id=m.id,o.loading=!0;let r={name:m.name,variable_count:m.variable_count,collect:m.collect,slave:0,subordinate:[],data:[]};H({id:m.id}).then(f=>{var b;if(o.loading=!1,(b=f.data)!=null&&b.id){r.slave=f.data.subordinate.length,r.subordinate=f.data.subordinate;let g=[];r.subordinate.forEach(a=>{a.variable.forEach(e=>{g.push({...e,slave_name:a.name})})}),r.data=g}o.info=r}).catch(()=>{o.loading=!1})}async function j(){let{template_id:m,info:r}=o;if(!m)return E.warning("请选择设备模板"),!1;let f=[];r.subordinate.forEach(b=>{f.push({subordinate_id:b.id,name:b.name,protocol:b.protocol})}),D("success",{template_id:m,template_name:r.name,data:f})}return h({open:l}),(m,r)=>{const f=_("a-radio"),b=_("a-list-item"),g=_("a-list"),a=_("a-table"),e=_("a-modal");return o.show?(p(),v("div",se,[s(e,{title:"选择模板",visible:o.show,"onUpdate:visible":r[2]||(r[2]=t=>o.show=t),width:"1000px","on-before-ok":j},{default:d(()=>[n("div",ne,[s(g,{bordered:!1,class:"mould-list","max-height":400,onReachBottom:r[1]||(r[1]=t=>U(o.page+1))},{default:d(()=>[(p(!0),v(S,null,$(o.mouldList,(t,u)=>(p(),M(b,{key:u,class:X({active:o.template_id===t.id}),onClick:c=>I(t)},{default:d(()=>[s(f,{value:t.id,modelValue:o.template_id,"onUpdate:modelValue":r[0]||(r[0]=c=>o.template_id=c)},{default:d(()=>[n("span",de,w(t.name),1)]),_:2},1032,["value","modelValue"])]),_:2},1032,["class","onClick"]))),128))]),_:1}),n("div",ie,[n("div",re,[n("span",ue,"从机数量："+w(o.info.slave),1),n("span",me,"变量数量："+w(o.info.variable_count),1),n("span",ce,"采集方式："+w(o.info.collect===1?"云端轮询":"边缘计算"),1)]),s(a,{class:"kd-small-table","row-key":"id",bordered:!1,data:o.info.data,columns:o.columns,loading:o.loading},{data_format:d(({record:t})=>[k(w(Y(W).dataFormat[t.data_format]),1)]),_:1},8,["data","columns","loading"])])])]),_:1},8,["visible"])])):x("",!0)}}},fe=B(_e,[["__scopeId","data-v-0e0dfecf"]]),pe={class:"kd-content"},be={class:"device-add-box"},ve={class:"label-box flex"},ge=["onClick"],we={class:"w600"},ke={key:0,class:"w400"},ye={class:"device-add-box mt20"},Ve={key:0},xe={key:0,class:"cong-ji-box mt10"},he={class:"cj-name fb f12"},Le={key:0,class:"cj-content flex-c"},De={class:"cj-content flex-c ml20"},Ie={class:"device-add-box mt20 mb20"},Ce={__name:"deviceAdd",setup(K){const h=R(),L=R(),D=R(),o=Z().query,l=q({loading:!1,saving:!1,form:{id:0,gateway_id:null,template_id:null,name:"",describe:"",label_ids:[],location:2,longitude:"",latitude:"",subordinate:[]},location:[],label:[],gatewayList:[],mouldInfo:null,template:null});ee(async()=>{var e,t;l.loading=!0,m();let a=null;if(o.id){let u=await P({id:o.id});(e=u.data)!=null&&e.id&&(a=u.data)}if(l.form={id:a?a.id:0,gateway_id:a?a.gateway_id:null,template_id:a?a.template_id:null,name:a?a.name:"",describe:a?a.describe:"",label_ids:[],location:a?a.location:2,longitude:a?a.longitude:"",latitude:a?a.latitude:"",subordinate:[]},a){if(l.mouldInfo={name:((t=a.template)==null?void 0:t.name)||"",subordinate:[]},a.label.length&&(l.label=a.label),a.location===1&&(l.location=[a.longitude,a.latitude]),a.label_ids&&typeof a.label_ids=="string"&&(l.form.label_ids=a.label_ids.split(",")),a!=null&&a.subordinate.length){let u=[];a.subordinate.forEach(c=>{var y;u.push({template_subordinate_id:c.template_subordinate_id,name:(y=c.subordinate)==null?void 0:y.name,serial_port:c.serial_port,subordinate_address:c.subordinate_address,protocol:c.protocol})}),l.mouldInfo.subordinate=u}l.template=a.template||null}l.loading=!1});const U=()=>h.value.open(l.template),I=()=>L.value.show(l.form.label_ids);function j(a){a&&(l.form.label_ids=a.id,l.label=a.list)}function m(a){let e={page:1,limit:20};a&&(e.name=a),te(e).then(t=>{var u;l.gatewayList=((u=t.data)==null?void 0:u.list)||[]})}function r(a){a&&(l.form.longitude=a.location[0],l.form.latitude=a.location[1])}function f(a){l.form.template_id=a.template_id;let e=[];console.log("data",a),a.data.forEach(t=>{e.push({template_subordinate_id:t.subordinate_id,protocol:t.protocol,name:t.name,serial_port:"",subordinate_address:""})}),l.mouldInfo={name:a.template_name,subordinate:e}}function b(){l.form.template_id=null,l.form.subordinate=[],l.mouldInfo=null}async function g(){if(await D.value.validate())return!1;let e=JSON.parse(JSON.stringify(l.form));if(e.id||delete e.id,l.mouldInfo){let t=[];l.mouldInfo.subordinate.forEach(u=>{t.push({serial_port:u.serial_port,subordinate_address:u.subordinate_address,template_subordinate_id:u.template_subordinate_id})}),e.subordinate=t}e.label_ids&&e.label_ids.length?e.label_ids=e.label_ids.join(","):e.label_ids="",l.saving=!0;try{let t=await Q(e);if(l.saving=!1,t.code===200){E.success("保存成功"),setTimeout(function(){ae.go(-1)},500);return}E.error(t.msg)}catch(t){console.log("js错误:",t)}}return(a,e)=>{const t=_("kd-back"),u=_("a-input"),c=_("a-form-item"),y=_("a-button"),N=_("a-radio"),T=_("a-radio-group"),F=_("a-popconfirm"),O=_("a-option"),A=_("a-select"),G=_("a-form"),J=_("kd-page-box");return p(),M(J,{loading:l.loading},{default:d(()=>[n("div",pe,[s(t,{title:"新增设备"}),s(G,{ref_key:"formRef",ref:D,model:l.form,"label-col-props":{flex:"110px"},"wrapper-col-props":{flex:1}},{default:d(()=>[n("div",be,[e[9]||(e[9]=n("div",{class:"f13 mb20"},"基本信息",-1)),s(c,{label:"设备名称",field:"name",rules:[{required:!0,message:"设备名称必填"}]},{default:d(()=>[s(u,{modelValue:l.form.name,"onUpdate:modelValue":e[0]||(e[0]=i=>l.form.name=i),placeholder:"请输入设备名称",class:"w600"},null,8,["modelValue"])]),_:1}),s(c,{label:"设备描述"},{default:d(()=>[s(u,{modelValue:l.form.describe,"onUpdate:modelValue":e[1]||(e[1]=i=>l.form.describe=i),placeholder:"请输入设备描述",class:"w600"},null,8,["modelValue"])]),_:1}),s(c,{label:"设备标签"},{default:d(()=>[n("div",ve,[(p(!0),v(S,null,$(l.label,(i,V)=>(p(),v("div",{class:"label-item",key:V},[k(w(i.name)+" ",1),n("div",{class:"del-icon",onClick:C=>a.delLabel(V)},e[5]||(e[5]=[n("i",{class:"ri-close-line"},null,-1)]),8,ge)]))),128)),s(y,{type:"outline",onClick:I},{default:d(()=>e[6]||(e[6]=[k("添加标签")])),_:1,__:[6]})])]),_:1}),s(c,{label:"设备位置"},{default:d(()=>[s(T,{modelValue:l.form.location,"onUpdate:modelValue":e[2]||(e[2]=i=>l.form.location=i)},{default:d(()=>[s(N,{value:2},{default:d(()=>e[7]||(e[7]=[k("网关定位")])),_:1,__:[7]}),s(N,{value:1},{default:d(()=>e[8]||(e[8]=[k("手动定位")])),_:1,__:[8]})]),_:1},8,["modelValue"])]),_:1}),l.form.location===1?(p(),M(c,{key:0,label:"设备地图"},{default:d(()=>[n("div",we,[l.loading?x("",!0):(p(),v("div",ke,[s(le,{lngLat:l.location,onSuccess:r},null,8,["lngLat"])]))])]),_:1})):x("",!0)]),n("div",ye,[e[14]||(e[14]=n("div",{class:"f13 mb20"},"数据设置",-1)),s(c,{label:"关联设备模板"},{default:d(()=>[n("div",null,[n("div",null,[l.form.template_id&&l.mouldInfo?(p(),v("span",Ve,[n("span",null,w(l.mouldInfo.name),1),s(F,{content:"确认请删除所选模板数据吗？",onOk:b},{default:d(()=>e[10]||(e[10]=[n("span",{class:"kd-link ml20 mr20"},"删除",-1)])),_:1,__:[10]})])):x("",!0),s(y,{type:"outline",onClick:U},{default:d(()=>e[11]||(e[11]=[k("选择模板")])),_:1,__:[11]})]),l.mouldInfo?(p(),v("div",xe,[(p(!0),v(S,null,$(l.mouldInfo.subordinate,(i,V)=>(p(),v("div",{class:"cj-item flex-c mt10",key:V},[n("div",he,w(i.name),1),i.protocol!==2?(p(),v("div",Le,[e[12]||(e[12]=n("span",null,"串口序号：",-1)),s(u,{modelValue:i.serial_port,"onUpdate:modelValue":C=>i.serial_port=C,placeholder:"串口序号",class:"w200"},null,8,["modelValue","onUpdate:modelValue"])])):x("",!0),n("div",De,[e[13]||(e[13]=n("span",null,"从机地址：",-1)),s(u,{modelValue:i.subordinate_address,"onUpdate:modelValue":C=>i.subordinate_address=C,placeholder:"从机地址",class:"w200"},null,8,["modelValue","onUpdate:modelValue"])])]))),128))])):x("",!0)])]),_:1})]),n("div",Ie,[e[15]||(e[15]=n("div",{class:"f13 mb20"},"联网设置",-1)),s(c,{label:"管理网关",modelValue:l.form.gateway_id,"onUpdate:modelValue":e[4]||(e[4]=i=>l.form.gateway_id=i)},{default:d(()=>[s(A,{class:"w600",placeholder:"请选择网关","allow-clear":"",modelValue:l.form.gateway_id,"onUpdate:modelValue":e[3]||(e[3]=i=>l.form.gateway_id=i),onSearch:m,"filter-option":!0,"allow-search":!0},{default:d(()=>[(p(!0),v(S,null,$(l.gatewayList,(i,V)=>(p(),M(O,{value:i.id,key:V},{default:d(()=>[k(w(i.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),s(c,null,{default:d(()=>[s(y,{type:"primary",class:"w120",loading:l.saving,onClick:g},{default:d(()=>e[16]||(e[16]=[k(" 保存 ")])),_:1,__:[16]},8,["loading"])]),_:1})]),_:1},8,["model"])]),s(fe,{ref_key:"mouldRef",ref:h,onSuccess:f},null,512),s(oe,{ref_key:"labelRef",ref:L,onSuccess:j},null,512)]),_:1},8,["loading"])}}},Ne=B(Ce,[["__scopeId","data-v-ec21e6f2"]]);export{Ne as default};
