import{h,i as A,j as E}from"./kdGateway-CmVadWVC.js";import{_ as G,m as I,i as O,r as R,E as S,j as T,p as v,w as t,d,o as f,a as k,b as l,f as _,c as x,F as j,l as q,t as F,M as y,g as J}from"./index-BIwpTUVt.js";const $={class:"kd-content mould-add"},z={key:0},P={__name:"mouldAdd",setup(H){const V=I().query,w=O(),a=R({loading:!1,form:{id:0,name:"",instruct:[{instruct_id:null,command:"",parameter:""}]},commandList:[],saving:!1}),N=S(()=>function(n){let e=a.commandList.findIndex(s=>s.id==n);return a.commandList[e].type!==1});T(async()=>{var e;a.loading=!0;let n=await h();if(n.code===200&&(a.commandList=((e=n.data)==null?void 0:e.list)||[]),V.id){let s=await A({id:V.id});if(s.code===200){let{id:r,name:i,instruct:p}=s.data,g=[];p.forEach(m=>{g.push({instruct_id:m.instruct_id,command:m.command,parameter:m.parameter,id:m.id})}),a.form={id:r,name:i,instruct:g}}}a.loading=!1});function b(n){if(n===-1)return a.form.instruct.push({instruct_id:null,command:"",parameter:""}),!1;a.form.instruct.splice(n,1)}async function L(){let n=await w.value.validate();if(console.log("valid",n),n)return!1;let e=JSON.parse(JSON.stringify(a.form));e.id||delete e.id;let s=!1;for(var r=0;r<e.instruct.length;r++)if(!e.instruct[r].instruct_id||!e.instruct[r].command){s=!0;break}if(s)return y.warning("请将型号功能内容填写完整后再提交!"),!1;a.saving=!0;try{let i=await E(e);if(a.saving=!1,i.code==200){y.success("添加成功"),setTimeout(function(){J.back()},500);return}y.error(i.msg)}catch{a.saving=!1}}return(n,e)=>{const s=d("a-button"),r=d("kd-back"),i=d("a-input"),p=d("a-form-item"),g=d("a-option"),m=d("a-select"),C=d("a-tag"),U=d("a-table"),D=d("a-form"),M=d("kd-page-box");return f(),v(M,{loading:a.loading},{default:t(()=>[k("div",$,[l(r,{title:"新增网关型号"},{default:t(()=>[l(s,{type:"primary",loading:a.saving,onClick:L},{default:t(()=>e[2]||(e[2]=[_("保存")])),_:1,__:[2]},8,["loading"])]),_:1}),l(D,{ref_key:"formRef",ref:w,model:a.form,"label-col-props":{flex:"140px"},"wrapper-col-props":{flex:1}},{default:t(()=>[l(p,{label:"网关型号",field:"name",rules:{required:!0,message:"网关型号必填"}},{default:t(()=>[l(i,{placeholder:"请输入网关型号",modelValue:a.form.name,"onUpdate:modelValue":e[0]||(e[0]=o=>a.form.name=o),class:"w600"},null,8,["modelValue"])]),_:1}),l(p,{label:"型号功能"},{default:t(()=>[l(U,{class:"w600 kd-small-table","row-key":"id",pagination:!1,data:a.form.instruct,columns:[{title:"功能名称",slotName:"name",width:200},{title:"AT指令",slotName:"command_str"},{title:"附加参数",slotName:"type"},{title:"操作",slotName:"action"}]},{name:t(({record:o,rowIndex:u})=>[l(m,{placeholder:"请选择指令",modelValue:o.instruct_id,"onUpdate:modelValue":c=>o.instruct_id=c,class:"w180"},{default:t(()=>[(f(!0),x(j,null,q(a.commandList,(c,B)=>(f(),v(g,{key:B,value:c.id},{default:t(()=>[_(F(c.name),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),command_str:t(({record:o})=>[l(i,{modelValue:o.command,"onUpdate:modelValue":u=>o.command=u,placeholder:"请输入附加参数"},null,8,["modelValue","onUpdate:modelValue"])]),type:t(({record:o})=>[o.instruct_id&&N.value(o.instruct_id)?(f(),x("div",z,[l(i,{modelValue:o.parameter,"onUpdate:modelValue":u=>o.parameter=u,placeholder:"请输入附加参数"},null,8,["modelValue","onUpdate:modelValue"])])):(f(),v(C,{key:1,color:"blue"},{default:t(()=>e[3]||(e[3]=[_("无参数")])),_:1,__:[3]}))]),action:t(({record:o,rowIndex:u})=>[l(s,{type:"text",size:"mini",class:"ml-10",onClick:c=>b(u)},{default:t(()=>e[4]||(e[4]=[_("删除")])),_:2,__:[4]},1032,["onClick"])]),footer:t(()=>[k("div",{class:"add-line",onClick:e[1]||(e[1]=o=>b(-1))},e[5]||(e[5]=[k("i",{class:"ri-add-line"},null,-1),_("新增指令")]))]),_:1},8,["data"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["loading"])}}},W=G(P,[["__scopeId","data-v-9c5ed7a8"]]);export{W as default};
